<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>828 Weather Direct</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, sans-serif;
  background: linear-gradient(to bottom right, #eef6ff, #dbeafe);
}

.container {
  max-width: 720px;
  margin: auto;
  padding: 20px;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
}

h1 { margin-top: 0; }
.small { font-size: 14px; color: #555; }

.alert {
  border-left: 6px solid #dc2626;
  background: #fee2e2;
}
</style>
</head>

<body>
<div class="container">
  <h1>828 Weather Direct</h1>
  <div id="content">Loading forecast...</div>
</div>

<script>
const LAT = 35.5951;
const LON = -82.5515;
const TZ = "America/New_York";

/* ----------------------------------------------------
   TOMORROW WINDOW (calendar-safe)
---------------------------------------------------- */
function getTomorrowWindow(hourly) {
  if (!hourly.time?.length) return { start: 24, end: 48 };

  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const target = tomorrow.toISOString().split("T")[0];

  let start = null;
  let end = null;

  for (let i = 0; i < hourly.time.length; i++) {
    if (hourly.time[i].split("T")[0] === target) {
      if (start === null) start = i;
      end = i + 1;
    }
  }

  if (start === null) return { start: 24, end: 48 };

  return { start, end };
}

/* ----------------------------------------------------
   HUMAN OUTLOOK
---------------------------------------------------- */
function generateHumanActionOutlook(hourly) {
  const { start, end } = getTomorrowWindow(hourly);

  const rain = hourly.precipitation || [];
  const temp = hourly.temperature_2m || [];
  const gust = hourly.windgusts_10m || [];
  const dew = hourly.dewpoint_2m || [];

  let rainTotal = 0;
  let maxTemp = -999;
  let minTemp = 999;
  let maxGust = 0;
  let maxDew = -999;

  for (let i = start; i < end; i++) {
    rainTotal += rain[i] ?? 0;
    maxTemp = Math.max(maxTemp, temp[i] ?? -999);
    minTemp = Math.min(minTemp, temp[i] ?? 999);
    maxGust = Math.max(maxGust, gust[i] ?? 0);
    maxDew = Math.max(maxDew, dew[i] ?? -999);
  }

  if (rainTotal >= 0.10)
    return { emoji: "ðŸ’§", headline: "Rain likely tomorrow", text: "Bring a rain jacket." };

  if (minTemp <= 35)
    return { emoji: "ðŸ¥¶", headline: "Cold morning expected", text: "Dress warmly." };

  if (maxDew >= 68 && maxTemp >= 82)
    return { emoji: "ðŸ˜…", headline: "Hot and humid", text: "Stay hydrated." };

  if (maxGust >= 30)
    return { emoji: "ðŸŒ¬ï¸", headline: "Gusty conditions", text: "Secure outdoor items." };

  return { emoji: "ðŸ™‚", headline: "Mild weather", text: "Comfortable overall." };
}

/* ----------------------------------------------------
   60-DAY HISTORY
---------------------------------------------------- */
async function getHistoricalDaily(lat, lon) {
  const end = new Date();
  const start = new Date();
  start.setDate(end.getDate() - 60);

  const url =
    `https://archive-api.open-meteo.com/v1/archive` +
    `?latitude=${lat}&longitude=${lon}` +
    `&start_date=${start.toISOString().split("T")[0]}` +
    `&end_date=${end.toISOString().split("T")[0]}` +
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum` +
    `&temperature_unit=fahrenheit` +
    `&timezone=${TZ}`;

  const res = await fetch(url);
  const data = await res.json();

  if (!data.daily) return [];

  return data.daily.time.map((date, i) => ({
    date,
    tMean:
      (data.daily.temperature_2m_max[i] +
        data.daily.temperature_2m_min[i]) / 2,
    precip: data.daily.precipitation_sum[i] ?? 0
  }));
}

/* ----------------------------------------------------
   CLIMATE NORMALS (SAFE VERSION)
---------------------------------------------------- */
async function getMonthlyNormals(lat, lon) {
  try {
    const url =
      `https://climate-api.open-meteo.com/v1/climate` +
      `?latitude=${lat}&longitude=${lon}` +
      `&start_year=1991&end_year=2020` +
      `&monthly=temperature_2m_mean` +
      `&timezone=${TZ}`;

    const res = await fetch(url);
    const data = await res.json();

    if (!data.monthly?.temperature_2m_mean) {
      throw new Error("Normals unavailable");
    }

    return data.monthly.temperature_2m_mean;
  } catch {
    console.warn("Using fallback Asheville normals.");

    return [
      39, 42, 50, 59, 67, 74,
      78, 77, 71, 60, 49, 41
    ];
  }
}

/* ----------------------------------------------------
   TREND ANALYSIS
---------------------------------------------------- */
function analyzeHistoricalTrends(daily, normals) {
  if (!daily.length) {
    return {
      headline: "Trend Unavailable",
      text: "Historical data unavailable."
    };
  }

  const last7 = daily.slice(-7);

  let anomalySum = 0;

  for (const d of last7) {
    const monthIndex = new Date(d.date).getMonth();
    const normal = normals[monthIndex];
    anomalySum += (d.tMean - normal);
  }

  const anomaly = anomalySum / last7.length;

  if (anomaly > 5)
    return {
      headline: "Recent Warm Spell",
      text: `Past week about ${anomaly.toFixed(1)}Â° above normal.`
    };

  if (anomaly < -5)
    return {
      headline: "Recent Cold Spell",
      text: `Past week about ${anomaly.toFixed(1)}Â° below normal.`
    };

  return {
    headline: "Near Seasonal Pattern",
    text: "Temperatures close to average for this time of year."
  };
}

/* ----------------------------------------------------
   LOAD EVERYTHING
---------------------------------------------------- */
async function loadWeather() {
  try {
    const forecastURL =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${LAT}&longitude=${LON}` +
      `&hourly=temperature_2m,precipitation,windgusts_10m,dewpoint_2m` +
      `&temperature_unit=fahrenheit` +
      `&timezone=${TZ}`;

    const forecastRes = await fetch(forecastURL);
    const forecastData = await forecastRes.json();

    if (!forecastData.hourly) {
      throw new Error("Forecast data unavailable");
    }

    const outlook = generateHumanActionOutlook(forecastData.hourly);

    const history = await getHistoricalDaily(LAT, LON);
    const normals = await getMonthlyNormals(LAT, LON);
    const trend = analyzeHistoricalTrends(history, normals);

    document.getElementById("content").innerHTML = `
      <div class="card">
        <h2>${outlook.emoji} ${outlook.headline}</h2>
        <p>${outlook.text}</p>
      </div>

      <div class="card">
        <h2>Climate Trend</h2>
        <p><strong>${trend.headline}</strong></p>
        <p>${trend.text}</p>
      </div>

      <div class="small">Data: Open-Meteo</div>
    `;
  } catch (err) {
    document.getElementById("content").innerHTML =
      "<div class='card alert'><h2>Error Loading Forecast</h2><p>" +
      err.message +
      "</p></div>";
  }
}

loadWeather();
</script>
</body>
</html>
