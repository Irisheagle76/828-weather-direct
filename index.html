<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>828 Weather Direct – WU Powered</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
    :root {
      --card-padding: 1.5rem;
      --module-padding: 1rem 1.2rem;
      --module-radius: 22px;
      --gap: 1.4rem;
    }

    @media (max-height: 700px), (max-width: 420px) {
      :root {
        --card-padding: 1rem;
        --module-padding: 0.85rem 1rem;
        --module-radius: 18px;
        --gap: 1rem;
      }
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0a0f1c;
      color: #f5f5f5;
      margin: 0;
      padding: var(--card-padding);
    }

    .card {
      max-width: 720px;
      margin: 0 auto;
      background: #141a2a;
      border-radius: var(--module-radius);
      padding: var(--card-padding);
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.05);
    }

    h1 {
      margin: 0 0 0.4rem;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9aa3c2;
      margin-bottom: var(--gap);
    }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: var(--gap);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f5c84c;
    }

    .badge-dot.ok { background: #ffa94d; }
    .badge-dot.error { background: #fb7185; }

    .status-text {
      font-size: 0.85rem;
      color: #c4c9e5;
    }

    .now-tomorrow-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--gap);
      margin-bottom: var(--gap);
    }

    .now-col,
    .tomorrow-col {
      flex: 1 1 260px;
      min-width: 0;
    }

    .comfort-module {
      background: rgba(255, 169, 77, 0.10);
      border: 1px solid rgba(255, 169, 77, 0.35);
      border-radius: var(--module-radius);
      padding: var(--module-padding);
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .comfort-emoji {
      font-size: 2rem;
      flex-shrink: 0;
    }

    .comfort-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #f0b777;
      margin-bottom: 0.15rem;
      white-space: nowrap;
    }

    .comfort-text {
      font-size: 1.02rem;
      font-weight: 600;
      color: #ffa94d;
      letter-spacing: 0.02em;
      line-height: 1.25;
    }

    .comfort-sub {
      font-size: 0.78rem;
      color: #9aa3c2;
      margin-top: 0.15rem;
    }

    /* UPDATED ACTION MODULE */

    .action-module {
      background: rgba(120, 180, 255, 0.10);
      border: 1px solid rgba(120, 180, 255, 0.35);
      border-radius: var(--module-radius);
      padding: var(--module-padding);
    }

    .action-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #8fb7ff;
      margin-bottom: 0.35rem;
      white-space: nowrap;
    }

    .action-alert-row {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .action-badge {
      font-size: 0.78rem;
      font-weight: 600;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      letter-spacing: 0.04em;
    }

    .action-emoji {
      font-size: 1.2rem;
      line-height: 1;
    }

    .action-headline {
      font-size: 1.25rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 0.3rem;
      line-height: 1.2;
    }

    .action-text {
      font-size: 0.82rem;
      color: #b9c7f5;
      line-height: 1.4;
    }

  </style>
</head>
<body>
<div class="card">
  <h1>828 Weather Direct</h1>
  <div class="subtitle">Hyper‑local conditions via Weather Underground PWS network</div>

  <div class="status-row">
    <div class="badge" id="wu-status-badge">
      <span class="badge-dot" id="wu-status-dot"></span>
      <span id="wu-status-label">Detecting location…</span>
    </div>
    <div class="status-text" id="wu-status-text">
      Waiting for browser location permission.
    </div>
  </div>

  <div class="now-tomorrow-row">
    <div class="now-col">
      <div id="comfort-module" class="comfort-module">
        <div id="comfort-emoji" class="comfort-emoji">--</div>
        <div>
          <div class="comfort-label">Right now comfort</div>
          <div id="comfort-text" class="comfort-text">Comfort loading…</div>
          <div class="comfort-sub">Based on current conditions</div>
        </div>
      </div>
    </div>

    <div class="tomorrow-col">
      <div id="action-module" class="action-module">
        <div id="action-emoji" class="action-emoji">--</div>
        <div>
          <div id="action-badge" class="action-badge"></div>
          <div class="action-label">Tomorrow’s human‑action outlook</div>
          <div id="action-headline" class="action-headline">Analyzing tomorrow’s setup…</div>
          <div id="action-text" class="action-text">
            We’ll highlight what you’ll actually need tomorrow — layers, rain gear, hydration, or nothing special.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="metric">
      <div class="metric-label">Temperature</div>
      <div class="metric-value" id="wu-temp">--</div>
      <div class="metric-sub" id="wu-feels">Feels like --</div>
    </div>

    <div class="metric">
      <div class="metric-label">Dew Point & Humidity</div>
      <div class="metric-value" id="wu-dew">--</div>
      <div class="metric-sub" id="wu-humidity">Humidity --</div>
    </div>

    <div class="metric">
      <div class="metric-label">Wind</div>
      <div class="metric-value" id="wu-wind">--</div>
      <div class="metric-sub" id="wu-wind-gust">Gusts --</div>
    </div>

    <div class="metric">
      <div class="metric-label">UV & Solar</div>
      <div class="metric-value" id="wu-uv">--</div>
      <div class="metric-sub" id="wu-solar">Solar --</div>
    </div>
  </div>

  <div class="error-text" id="wu-error" style="display:none;"></div>

  <div id="forecast-module" class="forecast-module">
    <div class="forecast-title">Upcoming Weather Alerts</div>
    <div id="forecast-icons" class="forecast-icons"></div>
    <div id="forecast-detail" class="forecast-detail"></div>
  </div>

  <div class="footer-note" id="wu-station-footer">
    Live data from Weather Underground Station --
  </div>
</div>
<script type="module">
  import {
    getHumanActionOutlook,
    getForecastAlerts,
    getComfortCategory as computeComfort
  } from './forecast-intel.js';

  const WU_API_KEY = "eba9581da59d4972a9581da59d497236";

  function setWUStatus(state, label, text) {
    const dot = document.getElementById("wu-status-dot");
    const lbl = document.getElementById("wu-status-label");
    const desc = document.getElementById("wu-status-text");

    lbl.textContent = label;
    desc.textContent = text;

    dot.classList.remove("ok", "error");
    if (state === "ok") dot.classList.add("ok");
    if (state === "error") dot.classList.add("error");
  }

  function showWUError(msg) {
    const el = document.getElementById("wu-error");
    el.textContent = msg;
    el.style.display = "block";
  }

  function getComfortCategory(tempF, dewF, windF = 0, precip = 0) {
    return computeComfort(tempF, dewF, windF, precip);
  }

  function updateComfortBadge(text) {
    const badge = document.getElementById("comfort-badge");
    if (!badge) return;
    badge.className = "comfort-badge";
    badge.innerText = "COMFORT";
  }

  function updateComfortPreview() {}
     async function getNearestWUStation(lat, lon, apiKey) {
    const url =
      `https://api.weather.com/v3/location/near?geocode=${lat},${lon}` +
      `&product=pws&format=json&apiKey=${apiKey}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error("WU station lookup failed: " + res.status);

    const data = await res.json();
    return {
      stationId: data.location.stationId[0],
      distance: data.location.distance?.[0] ?? null
    };
  }

  async function getWUCurrentConditions(stationId, apiKey) {
    const url =
      `https://api.weather.com/v2/pws/observations/current?stationId=${stationId}` +
      `&format=json&units=e&apiKey=${apiKey}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error("WU current conditions failed: " + res.status);

    const data = await res.json();
    const obs = data.observations[0];

    return {
      temp: obs.imperial?.temp ?? null,
      dewPoint: obs.imperial?.dewpt ?? null,
      humidity: obs.humidity ?? null,
      windSpeed: obs.imperial?.windSpeed ?? null,
      windGust: obs.imperial?.windGust ?? null,
      solarRadiation: obs.solarRadiation ?? null,
      uv: obs.uv ?? null,
      stationId: obs.stationID
    };
  }

  async function getShortTermForecast(lat, lon) {
    const url =
      `https://api.open-meteo.com/v1/forecast` +
      `?latitude=${lat}&longitude=${lon}` +
      `&hourly=temperature_2m,dewpoint_2m,precipitation,snowfall,windgusts_10m,uv_index` +
      `&forecast_days=3&timezone=America/New_York` +
      `&temperature_unit=fahrenheit` +
      `&dewpoint_unit=fahrenheit` +
      `&wind_speed_unit=mph` +
      `&precipitation_unit=inch`;

    const res = await fetch(url);
    if (!res.ok) throw new Error("Short-term forecast fetch failed: " + res.status);

    return (await res.json()).hourly;
  }

  function renderForecastIcons(alerts) {
    const container = document.getElementById("forecast-icons");
    const detailBox = document.getElementById("forecast-detail");

    container.innerHTML = "";
    detailBox.innerHTML = "";
    detailBox.style.display = "none";
    detailBox.dataset.open = "";

    alerts.forEach(alert => {
      const iconEl = document.createElement("span");
      iconEl.className = "forecast-icon";
      iconEl.textContent = alert.icon;
      iconEl.dataset.alertId = alert.id;

      iconEl.addEventListener("click", () => {
        if (detailBox.dataset.open === alert.id) {
          detailBox.style.display = "none";
          detailBox.dataset.open = "";
          return;
        }

        detailBox.innerHTML = `
          <div class="detail-title">${alert.icon} ${alert.title}</div>
          <div class="detail-text">${alert.detail}</div>
        `;
        detailBox.style.display = "block";
        detailBox.dataset.open = alert.id;
      });

      container.appendChild(iconEl);
    });
  }

  async function initWUWeather() {
    if (!navigator.geolocation) {
      showWUError("Geolocation is not supported by this browser.");
      return;
    }

    setWUStatus("pending", "Requesting Location", "Waiting for permission…");

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      try {
        const nearest = await getNearestWUStation(lat, lon, WU_API_KEY);
        const wu = await getWUCurrentConditions(nearest.stationId, WU_API_KEY);

        document.getElementById("wu-temp").textContent =
          wu.temp != null ? `${wu.temp.toFixed(0)}°F` : "--";

        document.getElementById("wu-feels").textContent =
          wu.temp != null ? `Feels like ${wu.temp.toFixed(0)}°F` : "Feels like --";

        const comfort = getComfortCategory(wu.temp, wu.dewPoint, wu.windGust ?? 0);
        document.getElementById("comfort-text").textContent = comfort.text;
        document.getElementById("comfort-emoji").textContent = comfort.emoji;

        document.getElementById("wu-dew").textContent =
          wu.dewPoint != null ? `${wu.dewPoint.toFixed(0)}°F` : "--";

        document.getElementById("wu-humidity").textContent =
          wu.humidity != null ? `Humidity ${wu.humidity}%` : "Humidity --";

        document.getElementById("wu-wind").textContent =
          wu.windSpeed != null ? `${wu.windSpeed.toFixed(0)} mph` : "--";

        document.getElementById("wu-wind-gust").textContent =
          wu.windGust != null ? `Gusts ${wu.windGust.toFixed(0)} mph` : "Gusts --";

        document.getElementById("wu-uv").textContent =
          wu.uv != null ? `UV ${wu.uv.toFixed(1)}` : "--";

        document.getElementById("wu-solar").textContent =
          wu.solarRadiation != null ? `${wu.solarRadiation.toFixed(0)} W/m²` : "Solar --";

        setWUStatus("ok", "WU Connected", "Weather Underground data loaded.");

        document.getElementById("wu-station-footer").textContent =
          `Live data from Weather Underground Station ${nearest.stationId}`;

        try {
          const hourly = await getShortTermForecast(lat, lon);

          const outlook = getHumanActionOutlook(hourly);

          const badgeEl = document.getElementById("action-badge");
          badgeEl.textContent = outlook.badge.text;
          badgeEl.className = "action-badge " + outlook.badge.class;

          document.getElementById("action-emoji").textContent = outlook.emoji;
          document.getElementById("action-headline").textContent = outlook.headline;
          document.getElementById("action-text").textContent = outlook.text;

          const alerts = getForecastAlerts(hourly);
          renderForecastIcons(alerts);

        } catch (fcErr) {
          console.error("Forecast error:", fcErr);
          document.getElementById("action-emoji").textContent = "❓";
          document.getElementById("action-headline").textContent =
            "Tomorrow’s outlook unavailable";
          document.getElementById("action-text").textContent =
            "We couldn’t load tomorrow’s forecast data.";
        }

      } catch (err) {
        console.error("WU init error:", err);
        setWUStatus("error", "WU Error", "Unable to load Weather Underground data.");
        showWUError("Unable to load local station data. Please try again later.");
      }
    }, (err) => {
      console.error("Geolocation error:", err);
      setWUStatus("error", "Location Error", "Location permission denied or unavailable.");
      showWUError("We couldn’t access your location. Please enable location services and reload.");
    });
  }

  document.addEventListener("DOMContentLoaded", initWUWeather);
</script>
</body>
</html>

