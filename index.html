<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>828 Weather Direct - Asheville</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; color: #1c1e21; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 5px solid #2e86de; }
        .alert-box { background: #d63031; color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; }
        .snow-box { background: #74b9ff; color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; }
        .bin-warning { background: #27ae60; color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; }
        h1 { color: #2d3436; font-size: 1.8em; margin-bottom: 5px; }
        .metric-label { font-weight: bold; color: #0984e3; text-transform: uppercase; font-size: 0.75em; display: block; }
        .metric-value { font-size: 1.1em; margin-bottom: 12px; }
        .trend-tag { background: #dfe6e9; padding: 3px 6px; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>

    <h1>828 Weather Direct</h1>
    <p style="color: #636e72; font-size: 0.9em; margin-top:-10px;">Hyper-local Asheville Forecast (Elev: 2,130 ft)</p>

    <div id="nws-alert" class="alert-box"></div>
    <div id="snow-alert" class="snow-box"></div>
    <div id="bin-alert" class="bin-warning"></div>

    <div class="card">
        <span class="metric-label">Human Comfort</span>
        <div id="comfort-report" class="metric-value">Loading comfort data...</div>

        <span class="metric-label">Garbage Bins</span>
        <div id="bin-status" class="metric-value">Checking wind...</div>
    </div>

    <div class="card">
        <span class="metric-label">Noticeable Trends</span>
        <p><b>Condition:</b> <span class="trend-tag">Notably Dry</span></p>
        <p style="font-size: 0.85em;">February is currently running below average for precipitation in the Asheville area.</p>
    </div>

    <script>
        const NWS_URL = "https://api.weather.gov/gridpoints/GSP/108,110/forecast";
        const ALERT_URL = "https://api.weather.gov/alerts/active?area=NC";
        
        // This Proxy "wraps" the NWS request so the browser doesn't block it
        const proxy = "https://api.allorigins.win/get?url=";

        async function updateWeather() {
            try {
                // 1. Fetch Forecast via Proxy
                const response = await fetch(proxy + encodeURIComponent(NWS_URL));
                const wrapper = await response.json();
                const data = JSON.parse(wrapper.contents);
                const now = data.properties.periods[0];

                // Human Comfort Logic
                const comfortDiv = document.getElementById('comfort-report');
                if (now.temperature >= 65) {
                    const dp = now.dewpoint ? (now.dewpoint.value * 9/5 + 32) : 40;
                    if (dp < 55) comfortDiv.innerText = "üß§ Crisp & Dry";
                    else if (dp <= 60) comfortDiv.innerText = "üëå Pleasant";
                    else if (dp <= 65) comfortDiv.innerText = "üíß Sticky";
                    else comfortDiv.innerText = "üå°Ô∏è Oppressive";
                } else {
                    comfortDiv.innerText = "Neutral (Temp below 65¬∞F)";
                }

                // Bin Alert Logic
                const windNumbers = now.windSpeed.match(/\d+/g);
                const maxWind = windNumbers ? Math.max(...windNumbers.map(Number)) : 0;
                const binStatus = document.getElementById('bin-status');
                if (maxWind >= 25) {
                    document.getElementById('bin-alert').innerHTML = `üö® BIN ALERT: Gusts at ${maxWind} mph. Secure your bins!`;
                    document.getElementById('bin-alert').style.display = 'block';
                    binStatus.innerText = "BRING THEM IN!";
                } else {
                    binStatus.innerText = "Safe to stay out (" + maxWind + " mph).";
                }

                // Snow Watch
                const snowPeriods = data.properties.periods.filter(p => p.detailedForecast.toLowerCase().includes("snow"));
                if (snowPeriods.length > 0) {
                    const snowDiv = document.getElementById('snow-alert');
                    snowDiv.innerHTML = "‚ùÑÔ∏è SNOW WATCH: Snow in the 5-day. (Amounts hidden until 48hr window).";
                    snowDiv.style.display = 'block';
                }

                // 2. Fetch Alerts via Proxy
                const aResponse = await fetch(proxy + encodeURIComponent(ALERT_URL));
                const aWrapper = await aResponse.json();
                const aData = JSON.parse(aWrapper.contents);
                const localAlerts = aData.features.filter(a => a.properties.areaDesc.includes("Buncombe"));
                if (localAlerts.length > 0) {
                    const alertDiv = document.getElementById('nws-alert');
                    alertDiv.innerText = `‚ö†Ô∏è NWS ALERT: ${localAlerts[0].properties.event}`;
                    alertDiv.style.display = 'block';
                }

            } catch (e) {
                console.error(e);
                document.getElementById('comfort-report').innerText = "System Offline (NWS Server Error)";
            }
        }

        updateWeather();
    </script>
</body>
</html>
