<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>828 Weather Direct – WU Powered</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1020;
      color: #f5f5f5;
      margin: 0;
      padding: 1.5rem;
    }
    .card {
      max-width: 720px;
      margin: 0 auto;
      background: #151a2b;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.06);
    }
    h1 {
      margin: 0 0 0.5rem;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #a5b0d0;
      margin-bottom: 1.25rem;
    }
    .status-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }
    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f5c84c;
    }
    .badge-dot.ok {
      background: #4ade80;
    }
    .badge-dot.error {
      background: #fb7185;
    }
    .status-text {
      font-size: 0.85rem;
      color: #c4c9e5;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .metric {
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 0.75rem 0.9rem;
      border: 1px solid rgba(255,255,255,0.04);
    }
    .metric-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #8f9ac4;
      margin-bottom: 0.25rem;
    }
    .metric-value {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .metric-sub {
      font-size: 0.8rem;
      color: #9fa8d8;
      margin-top: 0.15rem;
    }
    .footer-note {
      margin-top: 1.25rem;
      font-size: 0.78rem;
      color: #7f88b2;
    }
    .error-text {
      color: #fb7185;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }
    @media (max-width: 480px) {
      body {
        padding: 1rem;
      }
      .card {
        padding: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>828 Weather Direct</h1>
    <div class="subtitle">Hyper‑local conditions via Weather Underground PWS network</div>

    <div class="status-row">
      <div class="badge" id="wu-status-badge">
        <span class="badge-dot" id="wu-status-dot"></span>
        <span id="wu-status-label">Detecting location…</span>
      </div>
      <div class="status-text" id="wu-status-text">
        Waiting for browser location permission.
      </div>
    </div>

    <div class="grid">
      <div class="metric">
        <div class="metric-label">Temperature</div>
        <div class="metric-value" id="wu-temp">--</div>
        <div class="metric-sub" id="wu-feels">Feels like --</div>
      </div>
      <div class="metric">
        <div class="metric-label">Dew Point & Humidity</div>
        <div class="metric-value" id="wu-dew">--</div>
        <div class="metric-sub" id="wu-humidity">Humidity --</div>
      </div>
      <div class="metric">
        <div class="metric-label">Wind</div>
        <div class="metric-value" id="wu-wind">--</div>
        <div class="metric-sub" id="wu-wind-gust">Gusts --</div>
      </div>
      <div class="metric">
        <div class="metric-label">Pressure & Rain</div>
        <div class="metric-value" id="wu-pressure">--</div>
        <div class="metric-sub" id="wu-rain">Rain rate --</div>
      </div>
      <div class="metric">
        <div class="metric-label">UV & Solar</div>
        <div class="metric-value" id="wu-uv">--</div>
        <div class="metric-sub" id="wu-solar">Solar --</div>
      </div>
      <div class="metric">
        <div class="metric-label">Station</div>
        <div class="metric-value" id="wu-station-id">--</div>
        <div class="metric-sub" id="wu-station-meta">Locating nearest PWS…</div>
      </div>
    </div>

    <div class="error-text" id="wu-error" style="display:none;"></div>

    <div class="footer-note">
      Data from nearest Weather Underground personal weather station. Location is used only in your browser to find the closest station.
    </div>
  </div>

  <script>
    const WU_API_KEY = "eba9581da59d4972a9581da59d497236";
    console.log("Key exists at top:", WU_API_KEY);
    // ==========================
    // CONFIG
    // ==========================
    console.log("WU key loaded:", WU_API_KEY);
    // ==========================
    // UI helpers
    // ==========================
    function setWUStatus(state, label, text) {
      const dot = document.getElementById("wu-status-dot");
      const labelEl = document.getElementById("wu-status-label");
      const textEl = document.getElementById("wu-status-text");

      dot.classList.remove("ok", "error");
      if (state === "ok") dot.classList.add("ok");
      if (state === "error") dot.classList.add("error");

      labelEl.textContent = label;
      textEl.textContent = text;
    }

    function showWUError(msg) {
      const el = document.getElementById("wu-error");
      el.style.display = "block";
      el.textContent = msg;
    }

    // ==========================
    // Weather Underground calls
    // ==========================
   async function getNearestWUStation(lat, lon, apiKey) {
    const url = `https://api.weather.com/v3/location/near?geocode=${lat},${lon}&product=pws&format=json&apiKey=${apiKey}`;

    const res = await fetch(url);
    if (!res.ok) {
        throw new Error("WU station lookup failed: " + res.status);
    }

    const data = await res.json();

    // SAFETY CHECKS
    if (!data.location) {
        throw new Error("WU returned no location object.");
    }

    if (!data.location.stationId || data.location.stationId.length === 0) {
        throw new Error("No nearby Weather Underground PWS stations found.");
    }

    return {
        stationId: data.location.stationId[0],
        distance: data.location.distance?.[0] ?? null,
        city: data.location.city?.[0] ?? null,
        neighborhood: data.location.neighborhood?.[0] ?? null
    };
}

async function initWUWeather() {

    // Correct API key validation
   if (!WU_API_KEY || WU_API_KEY === "eba9581da59d4972a9581da59d497236") {
    setWUStatus("error", "WU Key Missing", "Your Weather Underground API key is missing.");
    showWUError("Your Weather Underground API key is missing or invalid.");
    return;
}

    console.log("WU key validated:", WU_API_KEY);

    if (!navigator.geolocation) {
        setWUStatus("error", "Location Unavailable", "Geolocation is not supported in this browser.");
        showWUError("Your browser does not support geolocation, so we can't find the nearest station.");
        return;
    }

    setWUStatus("pending", "Requesting Location", "Waiting for permission to access your location…");

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        try {
            setWUStatus("pending", "Finding Station", "Locating the nearest Weather Underground PWS…");
            const nearest = await getNearestWUStation(lat, lon, WU_API_KEY);

            document.getElementById("wu-station-id").textContent = nearest.stationId;
            document.getElementById("wu-station-meta").textContent =
                `${nearest.neighborhood || nearest.city || "Nearby"} • ${nearest.distance.toFixed(1)} mi`;

            setWUStatus("pending", "Fetching Observations", "Pulling current conditions from the nearest station…");
            const wu = await getWUCurrentConditions(nearest.stationId, WU_API_KEY);

            // Update UI
            document.getElementById("wu-temp").textContent =
                wu.temp != null ? `${wu.temp.toFixed(0)}°F` : "--";
            document.getElementById("wu-dew").textContent =
                wu.dewPoint != null ? `${wu.dewPoint.toFixed(0)}°F` : "--";
            document.getElementById("wu-humidity").textContent =
                wu.humidity != null ? `Humidity ${wu.humidity}%` : "Humidity --";

            document.getElementById("wu-wind").textContent =
                wu.windSpeed != null ? `${wu.windSpeed.toFixed(0)} mph` : "--";
            document.getElementById("wu-wind-gust").textContent =
                wu.windGust != null ? `Gusts ${wu.windGust.toFixed(0)} mph` : "Gusts --";

            document.getElementById("wu-pressure").textContent =
                wu.pressure != null ? `${wu.pressure.toFixed(2)} inHg` : "--";
            document.getElementById("wu-rain").textContent =
                wu.rainRate != null ? `Rate ${wu.rainRate.toFixed(2)} in/hr` : "Rain rate --";

            document.getElementById("wu-uv").textContent =
                wu.uv != null ? `UV ${wu.uv.toFixed(1)}` : "--";
            document.getElementById("wu-solar").textContent =
                wu.solarRadiation != null ? `${wu.solarRadiation.toFixed(0)} W/m²` : "Solar --";

            document.getElementById("wu-feels").textContent =
                wu.temp != null ? `Feels like ${wu.temp.toFixed(0)}°F` : "Feels like --";

            setWUStatus("ok", "WU Connected", `Live data from ${nearest.stationId} • Updated ${wu.obsTimeLocal || "just now"}`);

        } catch (err) {
            console.error(err);
            setWUStatus("error", "WU Error", "We couldn't load data from Weather Underground.");
            showWUError(err.message || "Unknown error while fetching Weather Underground data.");
        }

    }, (err) => {
        console.error(err);
        setWUStatus("error", "Location Denied", "We can't find a nearby station without your location.");
        showWUError("Location access was denied. Enable location to get hyper‑local conditions.");
    });
}

    document.addEventListener("DOMContentLoaded", initWUWeather);
  </script>
</body>
</html>






