<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>828 Weather Direct ‚Äì WU Powered</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0a0f1c;
      color: #f5f5f5;
      margin: 0;
      padding: 1.5rem;
    }
    .card {
      max-width: 720px;
      margin: 0 auto;
      background: #141a2a;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.05);
    }
    h1 {
      margin: 0 0 0.5rem;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #9aa3c2;
      margin-bottom: 1.25rem;
    }
    .status-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }
    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f5c84c;
    }
    .badge-dot.ok {
      background: #ffa94d;
    }
    .badge-dot.error {
      background: #fb7185;
    }
    .status-text {
      font-size: 0.85rem;
      color: #c4c9e5;
    }

    /* Comfort Module */
    .comfort-module {
      background: rgba(255, 169, 77, 0.10);
      border: 1px solid rgba(255, 169, 77, 0.35);
      border-radius: 14px;
      padding: 1rem 1.2rem;
      margin-bottom: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.9rem;
    }
    .comfort-emoji {
      font-size: 2rem;
    }
    .comfort-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: #ffa94d;
      letter-spacing: 0.02em;
    }

    /* Metrics Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .metric {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 0.75rem 0.9rem;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .metric-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #f0b777;
      margin-bottom: 0.25rem;
    }
    .metric-value {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .metric-sub {
      font-size: 0.8rem;
      color: #9aa3c2;
      margin-top: 0.15rem;
    }

    /* Forecast Alerts Module */
    .forecast-module {
      margin-top: 1.6rem;
      background: rgba(255, 169, 77, 0.10);
      border: 1px solid rgba(255, 169, 77, 0.25);
      border-radius: 14px;
      padding: 1rem 1.2rem;
    }
    .forecast-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #ffa94d;
      margin-bottom: 0.6rem;
      letter-spacing: 0.03em;
    }
    .forecast-icons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      font-size: 2rem; /* LARGE ICONS */
      cursor: pointer;
    }
    .forecast-icon {
      transition: transform 0.15s ease;
    }
    .forecast-icon:hover {
      transform: scale(1.2);
    }
    .forecast-detail {
      margin-top: 0.9rem;
      padding: 0.8rem 1rem;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      display: none;
    }
    .detail-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #ffa94d;
    }
    .detail-text {
      font-size: 0.85rem;
      color: #d8d8e0;
      line-height: 1.35;
    }

    /* Trend Module */
    .trend-module {
      margin-top: 1.6rem;
      background: rgba(255, 169, 77, 0.10);
      border: 1px solid rgba(255, 169, 77, 0.25);
      border-radius: 14px;
      padding: 1rem 1.2rem;
    }
    .trend-headline {
      font-size: 1.05rem;
      font-weight: 700;
      color: #ffa94d;
      margin-bottom: 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .trend-text {
      font-size: 0.9rem;
      color: #d8d8e0;
      line-height: 1.35;
    }

    .footer-note {
      margin-top: 1.25rem;
      font-size: 0.78rem;
      color: #e0b27a;
    }
    .error-text {
      color: #fb7185;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>828 Weather Direct</h1>
    <div class="subtitle">Hyper‚Äëlocal conditions via Weather Underground PWS network</div>

    <div class="status-row">
      <div class="badge" id="wu-status-badge">
        <span class="badge-dot" id="wu-status-dot"></span>
        <span id="wu-status-label">Detecting location‚Ä¶</span>
      </div>
      <div class="status-text" id="wu-status-text">
        Waiting for browser location permission.
      </div>
    </div>

    <!-- Comfort Module -->
    <div id="comfort-module" class="comfort-module">
      <div id="comfort-emoji" class="comfort-emoji">--</div>
      <div id="comfort-text" class="comfort-text">Comfort loading‚Ä¶</div>
    </div>

    <!-- Metrics Grid (Pressure & Rain REMOVED) -->
    <div class="grid">
      <div class="metric">
        <div class="metric-label">Temperature</div>
        <div class="metric-value" id="wu-temp">--</div>
        <div class="metric-sub" id="wu-feels">Feels like --</div>
        <div class="metric-sub" id="wu-comfort">Comfort --</div>
      </div>

      <div class="metric">
        <div class="metric-label">Dew Point & Humidity</div>
        <div class="metric-value" id="wu-dew">--</div>
        <div class="metric-sub" id="wu-humidity">Humidity --</div>
      </div>

      <div class="metric">
        <div class="metric-label">Wind</div>
        <div class="metric-value" id="wu-wind">--</div>
        <div class="metric-sub" id="wu-wind-gust">Gusts --</div>
      </div>

      <div class="metric">
        <div class="metric-label">UV & Solar</div>
        <div class="metric-value" id="wu-uv">--</div>
        <div class="metric-sub" id="wu-solar">Solar --</div>
      </div>
    </div>

    <div class="error-text" id="wu-error" style="display:none;"></div>

    <!-- Forecast Alerts Module -->
    <div class="forecast-module">
      <div class="forecast-title">Upcoming Weather Alerts</div>
      <div id="forecast-icons" class="forecast-icons"></div>
      <div id="forecast-detail" class="forecast-detail"></div>
    </div>

    <!-- Trend Module -->
    <div id="trend-module" class="trend-module">
      <div id="trend-headline" class="trend-headline">Analyzing recent weather‚Ä¶</div>
      <div id="trend-text" class="trend-text">Looking back over the last 60 days‚Ä¶</div>
    </div>

    <div class="footer-note" id="wu-station-footer">
      Station: --
    </div>
  </div>

  <script>
    const WU_API_KEY = "eba9581da59d4972a9581da59d497236";

    /* -----------------------------------------
       UI STATUS HELPER (IMPORTANT!)
    ----------------------------------------- */
    function setWUStatus(state, label, text) {
      const dot = document.getElementById("wu-status-dot");
      const labelEl = document.getElementById("wu-status-label");
      const textEl = document.getElementById("wu-status-text");

      dot.classList.remove("ok", "error");
      if (state === "ok") dot.classList.add("ok");
      if (state === "error") dot.classList.add("error");

      labelEl.textContent = label;
      textEl.textContent = text;
    }

    function showWUError(msg) {
      const el = document.getElementById("wu-error");
      el.style.display = "block";
      el.textContent = msg;
    }

    /* -----------------------------------------
       COMFORT LOGIC (Goldilocks)
    ----------------------------------------- */
    function getComfortCategory(temp, dew) {
      if (temp == null || dew == null) {
        return { text: "Comfort unavailable", emoji: "‚ùì" };
      }

      if (temp >= 68 && temp <= 74 && dew >= 45 && dew <= 52) {
        return { text: "Goldilocks! Just right", emoji: "‚ú®" };
      }

      const humidityEffect = temp - dew;

      if (temp >= 85 && humidityEffect < 15)
        return { text: "Hot & Humid", emoji: "ü•µ" };

      if (temp >= 85)
        return { text: "Hot but Dry", emoji: "üåµ" };

      if (temp >= 70 && humidityEffect < 10)
        return { text: "Warm & Muggy", emoji: "üòÖ" };

      if (temp >= 70)
        return { text: "Warm & Pleasant", emoji: "üôÇ" };

      if (temp >= 55)
        return { text: "Cool & Comfortable", emoji: "üòä" };

      if (temp >= 40)
        return { text: "Chilly ‚Äî Light Jacket Recommended", emoji: "üß•" };

      if (temp >= 25)
        return { text: "Cold ‚Äî Bundle Up", emoji: "üß£" };

      return { text: "Frigid ‚Äî Stay Warm", emoji: "ü•∂" };
    }

    /* -----------------------------------------
       60‚ÄëDAY HISTORICAL FETCH (Open‚ÄëMeteo)
    ----------------------------------------- */
    async function getHistoricalDaily(lat, lon) {
      const end = new Date();
      end.setDate(end.getDate() - 1);
      const start = new Date();
      start.setDate(end.getDate() - 59);

      const fmt = d => d.toISOString().slice(0, 10);

      const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${lat}&longitude=${lon}` +
        `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum` +
        `&timezone=auto&start_date=${fmt(start)}&end_date=${fmt(end)}`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Historical trend fetch failed: " + res.status);

      const data = await res.json();
      const daily = [];

      for (let i = 0; i < data.daily.time.length; i++) {
        const tMax = data.daily.temperature_2m_max[i];
        const tMin = data.daily.temperature_2m_min[i];
        const precip = data.daily.precipitation_sum[i];
        daily.push({
          date: data.daily.time[i],
          tMax,
          tMin,
          tMean: (tMax + tMin) / 2,
          precip
        });
      }

      return daily;
    }
        /* -----------------------------------------
       60‚ÄëDAY TREND ANALYSIS (Headline + Secondary)
    ----------------------------------------- */
    function analyzeHistoricalTrends(daily) {
      if (!daily || daily.length === 0) {
        return {
          headline: "Trend Data Unavailable",
          text: "Unable to analyze the last 60 days of weather."
        };
      }

      const n = daily.length;
      const last7 = daily.slice(-7);
      const last30 = daily.slice(-30);

      /* Temperature anomaly */
      const overallMean = daily.reduce((s, d) => s + d.tMean, 0) / n;
      const recentMean = last7.reduce((s, d) => s + d.tMean, 0) / last7.length;
      const tempAnomaly = recentMean - overallMean;

      let tempPhrase = "";
      let tempIcon = "";

      if (tempAnomaly >= 5) {
        tempPhrase = `Temperatures this past week have been running about ${tempAnomaly.toFixed(0)}¬∞ warmer than the recent 60‚Äëday average`;
        tempIcon = "üå§Ô∏è";
      } else if (tempAnomaly <= -5) {
        tempPhrase = `Temperatures this past week have been running about ${Math.abs(tempAnomaly).toFixed(0)}¬∞ cooler than the recent 60‚Äëday average`;
        tempIcon = "‚ùÑÔ∏è";
      } else {
        tempPhrase = "Temperatures this past week have been close to the recent 60‚Äëday average";
        tempIcon = "üå¶Ô∏è";
      }

      /* Dry / wet streaks */
      let longestDry = 0, currentDry = 0;
      let longestWet = 0, currentWet = 0;

      for (let i = 0; i < n; i++) {
        const p = daily[i].precip || 0;

        if (p < 0.01) {
          currentDry++;
          longestDry = Math.max(longestDry, currentDry);
        } else {
          currentDry = 0;
        }

        if (p >= 0.1) {
          currentWet++;
          longestWet = Math.max(longestWet, currentWet);
        } else {
          currentWet = 0;
        }
      }

      /* Ongoing streaks */
      let ongoingDry = 0;
      for (let i = n - 1; i >= 0; i--) {
        if ((daily[i].precip || 0) < 0.01) ongoingDry++;
        else break;
      }

      let ongoingWet = 0;
      for (let i = n - 1; i >= 0; i--) {
        if ((daily[i].precip || 0) >= 0.1) ongoingWet++;
        else break;
      }

      let precipPhrase = "";
      let precipIcon = "";

      if (ongoingDry >= 3) {
        precipPhrase = `with an ongoing dry stretch of ${ongoingDry} days`;
        precipIcon = "üåû";
      } else if (ongoingWet >= 3) {
        precipPhrase = `with an ongoing wet stretch of ${ongoingWet} days`;
        precipIcon = "üåßÔ∏è";
      } else if (longestDry >= 5) {
        precipPhrase = `including a notable dry spell that lasted ${longestDry} days`;
        precipIcon = "üåû";
      } else if (longestWet >= 5) {
        precipPhrase = `including a notably soggy stretch that lasted ${longestWet} days`;
        precipIcon = "üåßÔ∏è";
      } else {
        precipPhrase = "with mixed precipitation patterns";
        precipIcon = "üå¶Ô∏è";
      }

      /* Headline (Option B tone) */
      let headline = "";

      if (ongoingDry >= 3) headline = `${precipIcon} A Dry Stretch Is Underway`;
      else if (ongoingWet >= 3) headline = `${precipIcon} A Wet Pattern Has Been Persistent`;
      else if (tempAnomaly >= 5) headline = `${tempIcon} A Warm Spell Has Taken Hold`;
      else if (tempAnomaly <= -5) headline = `${tempIcon} A Cold Snap Is Settling In`;
      else headline = `${tempIcon} Recent Weather Has Been Near Average`;

      const text = `${tempPhrase}, ${precipPhrase}.`;

      return { headline, text };
    }

    /* -----------------------------------------
       72‚ÄëHOUR FORECAST FETCH (Open‚ÄëMeteo)
    ----------------------------------------- */
    async function getShortTermForecast(lat, lon) {
      const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${lat}&longitude=${lon}` +
        `&hourly=temperature_2m,precipitation,snowfall,windgusts_10m` +
        `&forecast_days=3&timezone=auto`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Short-term forecast fetch failed: " + res.status);

      const data = await res.json();
      return data.hourly;
    }

    /* -----------------------------------------
       FORECAST ALERT LOGIC (48‚Äì72 hours)
    ----------------------------------------- */
    function analyzeForecastAlerts(hourly) {
      const hours = hourly.time.length;

      let rainTotal = 0;
      let snowTotal = 0;
      let maxGust = 0;
      let maxTemp = -999;
      let minTemp = 999;

      for (let i = 0; i < hours; i++) {
        rainTotal += hourly.precipitation[i];
        snowTotal += hourly.snowfall[i];
        maxGust = Math.max(maxGust, hourly.windgusts_10m[i]);
        maxTemp = Math.max(maxTemp, hourly.temperature_2m[i]);
        minTemp = Math.min(minTemp, hourly.temperature_2m[i]);
      }

      const alerts = [];

      if (rainTotal >= 0.5) {
        alerts.push({
          icon: "üíß",
          id: "rain",
          title: "Heavy Rain Expected",
          detail: `Up to ${rainTotal.toFixed(2)}" of rain is forecast in the next 72 hours.`
        });
      }

      if (snowTotal >= 1.0) {
        alerts.push({
          icon: "‚ùÑÔ∏è",
          id: "snow",
          title: "Snowfall Expected",
          detail: `${snowTotal.toFixed(1)}" of snow is forecast in the next 72 hours.`
        });
      }

      if (maxGust >= 35) {
        alerts.push({
          icon: "üå¨Ô∏è",
          id: "wind",
          title: "Strong Winds Ahead",
          detail: `Wind gusts may reach ${maxGust.toFixed(0)} mph.`
        });
      }

      if (maxTemp >= 85) {
        alerts.push({
          icon: "üî•",
          id: "hot",
          title: "Heat Spike Expected",
          detail: `High temperatures may exceed ${maxTemp.toFixed(0)}¬∞F.`
        });
      }

      if (minTemp <= 15) {
        alerts.push({
          icon: "ü•∂",
          id: "cold",
          title: "Bitter Cold Incoming",
          detail: `Lows may fall to ${minTemp.toFixed(0)}¬∞F.`
        });
      }

      return alerts;
    }

    /* -----------------------------------------
       RENDER FORECAST ALERT ICONS + DETAIL PANEL
    ----------------------------------------- */
    function renderForecastIcons(alerts) {
      const container = document.getElementById("forecast-icons");
      const detailBox = document.getElementById("forecast-detail");

      container.innerHTML = "";
      detailBox.innerHTML = "";
      detailBox.style.display = "none";

      if (alerts.length === 0) {
        container.innerHTML = `<div class="no-alerts">No significant alerts in the next 72 hours.</div>`;
        return;
      }

      alerts.forEach(alert => {
        const iconEl = document.createElement("span");
        iconEl.className = "forecast-icon";
        iconEl.textContent = alert.icon;
        iconEl.dataset.alertId = alert.id;

        iconEl.addEventListener("click", () => {
          if (detailBox.dataset.open === alert.id) {
            detailBox.style.display = "none";
            detailBox.dataset.open = "";
            return;
          }

          detailBox.innerHTML = `
            <div class="detail-title">${alert.icon} ${alert.title}</div>
            <div class="detail-text">${alert.detail}</div>
          `;
          detailBox.style.display = "block";
          detailBox.dataset.open = alert.id;
        });

        container.appendChild(iconEl);
      });
    }

    /* -----------------------------------------
       WEATHER UNDERGROUND (CURRENT CONDITIONS)
    ----------------------------------------- */
    async function getNearestWUStation(lat, lon, apiKey) {
      const url = `https://api.weather.com/v3/location/near?geocode=${lat},${lon}&product=pws&format=json&apiKey=${apiKey}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("WU station lookup failed: " + res.status);

      const data = await res.json();
      return {
        stationId: data.location.stationId[0],
        distance: data.location.distance?.[0] ?? null
      };
    }

    async function getWUCurrentConditions(stationId, apiKey) {
      const url = `https://api.weather.com/v2/pws/observations/current?stationId=${stationId}&format=json&units=e&apiKey=${apiKey}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("WU current conditions failed: " + res.status);

      const data = await res.json();
      const obs = data.observations[0];

      return {
        temp: obs.imperial?.temp ?? null,
        dewPoint: obs.imperial?.dewpt ?? null,
        humidity: obs.humidity ?? null,
        windSpeed: obs.imperial?.windSpeed ?? null,
        windGust: obs.imperial?.windGust ?? null,
        pressure: obs.imperial?.pressure ?? null,
        rainRate: obs.imperial?.precipRate ?? null,
        rainToday: obs.imperial?.precipTotal ?? null,
        solarRadiation: obs.solarRadiation ?? null,
        uv: obs.uv ?? null,
        stationId: obs.stationID
      };
    }

    /* -----------------------------------------
       MAIN FLOW
    ----------------------------------------- */
    async function initWUWeather() {
      if (!navigator.geolocation) {
        showWUError("Geolocation is not supported.");
        return;
      }

      setWUStatus("pending", "Requesting Location", "Waiting for permission‚Ä¶");

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        try {
          /* WU CURRENT CONDITIONS */
          const nearest = await getNearestWUStation(lat, lon, WU_API_KEY);
          const wu = await getWUCurrentConditions(nearest.stationId, WU_API_KEY);

          document.getElementById("wu-temp").textContent =
            wu.temp != null ? `${wu.temp.toFixed(0)}¬∞F` : "--";

          document.getElementById("wu-feels").textContent =
            wu.temp != null ? `Feels like ${wu.temp.toFixed(0)}¬∞F` : "Feels like --";

          const comfort = getComfortCategory(wu.temp, wu.dewPoint);
          document.getElementById("comfort-text").textContent = comfort.text;
          document.getElementById("comfort-emoji").textContent = comfort.emoji;
          document.getElementById("wu-comfort").textContent = `Comfort: ${comfort.text}`;

          document.getElementById("wu-dew").textContent =
            wu.dewPoint != null ? `${wu.dewPoint.toFixed(0)}¬∞F` : "--";

          document.getElementById("wu-humidity").textContent =
            wu.humidity != null ? `Humidity ${wu.humidity}%` : "Humidity --";

          document.getElementById("wu-wind").textContent =
            wu.windSpeed != null ? `${wu.windSpeed.toFixed(0)} mph` : "--";

          document.getElementById("wu-wind-gust").textContent =
            wu.windGust != null ? `Gusts ${wu.windGust.toFixed(0)} mph` : "Gusts --";

          document.getElementById("wu-uv").textContent =
            wu.uv != null ? `UV ${wu.uv.toFixed(1)}` : "--";

          document.getElementById("wu-solar").textContent =
            wu.solarRadiation != null ? `${wu.solarRadiation.toFixed(0)} W/m¬≤` : "Solar --";

          setWUStatus("ok", "WU Connected", `Live data from ${nearest.stationId}`);

          /* 60‚ÄëDAY TREND */
          try {
            const dailyHistory = await getHistoricalDaily(lat, lon);
            const trend = analyzeHistoricalTrends(dailyHistory);
            document.getElementById("trend-headline").textContent = trend.headline;
            document.getElementById("trend-text").textContent = trend.text;
          } catch (trendErr) {
            document.getElementById("trend-headline").textContent = "Trend Data Unavailable";
            document.getElementById("trend-text").textContent =
              "Unable to load recent 60‚Äëday trend details.";
          }

          /* FORECAST ALERTS (48‚Äì72 hours) */
          try {
            const hourly = await getShortTermForecast(lat, lon);
            const alerts = analyzeForecastAlerts(hourly);
            renderForecastIcons(alerts);
          } catch (forecastErr) {
            document.getElementById("forecast-icons").innerHTML =
              `<div class="no-alerts">Unable to load forecast alerts.</div>`;
          }

        } catch (err) {
          setWUStatus("error", "WU Error", "Could not load Weather Underground data.");
          showWUError(err.message || "Unknown error.");
        }

      }, () => {
        showWUError("Enable location to get hyper‚Äëlocal conditions.");
      });
    }

    document.addEventListener("DOMContentLoaded", initWUWeather);
  </script>
</body>
</html>
