<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>828 Weather Direct - Asheville</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; color: #1c1e21; line-height: 1.5; padding: 20px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-left: 5px solid #2e86de; }
        .alert-box { background: #d63031; color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; }
        .snow-box { background: #74b9ff; color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; }
        .bin-warning { background: #27ae60; color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; }
        h1 { color: #2d3436; font-size: 1.8em; margin-bottom: 5px; }
        .metric-label { font-weight: bold; color: #0984e3; text-transform: uppercase; font-size: 0.75em; display: block; }
        .metric-value { font-size: 1.1em; margin-bottom: 12px; }
        .trend-tag { background: #dfe6e9; padding: 3px 6px; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>

    <h1>828 Weather Direct</h1>
    <p style="color: #636e72; font-size: 0.9em; margin-top:-10px;">Hyper-local Asheville Forecast (Elev: 2,130 ft)</p>

    <div id="nws-alert" class="alert-box"></div>
    <div id="snow-alert" class="snow-box"></div>
    <div id="bin-alert" class="bin-warning"></div>

    <div class="card">
        <span class="metric-label">Human Comfort</span>
        <div class="metric-value" id="comfort-report">Connecting to Asheville sensors...</div>

        <span class="metric-label">Garbage Bins</span>
        <div class="metric-value" id="bin-status">Monitoring wind speeds...</div>
    </div>

    <div class="card">
        <span class="metric-label">Noticeable Trends</span>
        <p><b>Condition:</b> <span class="trend-tag">Notably Dry</span></p>
        <p style="font-size: 0.85em;">February is currently running below average for precipitation in the French Broad Valley.</p>
    </div>

    <script>
        // Using the primary forecast endpoint for better browser compatibility
        const FORECAST_URL = "https://api.weather.gov/gridpoints/GSP/108,110/forecast";
        const ALERTS_URL = "https://api.weather.gov/alerts/active?area=NC";

        async function updateWeather() {
            try {
                // Fetch Forecast
                const fReq = await fetch(FORECAST_URL);
                if (!fReq.ok) throw new Error("NWS Handshake Failed");
                const fData = await fReq.json();
                const periods = fData.properties.periods;
                const now = periods[0];

                // 1. Human Comfort (Dew Point Logic)
                const comfortDiv = document.getElementById('comfort-report');
                if (now.temperature >= 65) {
                    // Pulling dewpoint from the forecast object
                    const dp = now.dewpoint ? (now.dewpoint.value * 9/5 + 32) : 0;
                    if (dp > 0) {
                        if (dp < 55) comfortDiv.innerText = "üß§ Crisp & Dry";
                        else if (dp <= 60) comfortDiv.innerText = "üëå Pleasant";
                        else if (dp <= 65) comfortDiv.innerText = "üíß Sticky";
                        else comfortDiv.innerText = "üå°Ô∏è Oppressive";
                    } else {
                        comfortDiv.innerText = "Neutral (Low Humidity)";
                    }
                } else {
                    comfortDiv.innerText = "Neutral (Temp below 65¬∞F)";
                }

                // 2. Bin Alert Logic (Wind >= 25mph)
                const windNumbers = now.windSpeed.match(/\d+/g);
                const maxWind = windNumbers ? Math.max(...windNumbers.map(Number)) : 0;
                const binStatus = document.getElementById('bin-status');
                if (maxWind >= 25) {
                    document.getElementById('bin-alert').innerHTML = `üö® BIN ALERT: Gusts at ${maxWind} mph. Secure your bins!`;
                    document.getElementById('bin-alert').style.display = 'block';
                    binStatus.innerText = "BRING THEM IN!";
                } else {
                    binStatus.innerText = "Safe to stay out (" + maxWind + " mph).";
                }

                // 3. Snow Watch (48-Hour Rule)
                const snowPeriods = periods.filter(p => p.detailedForecast.toLowerCase().includes("snow"));
                if (snowPeriods.length > 0) {
                    const snowDiv = document.getElementById('snow-alert');
                    const firstSnow = snowPeriods[0];
                    const startTime = new Date(firstSnow.startTime);
                    const hoursUntilSnow = (startTime - new Date()) / 36e5;
                    let snowMsg = "‚ùÑÔ∏è SNOW WATCH: Snow is in the forecast.";
                    if (hoursUntilSnow <= 48) {
                        snowMsg += " Accumulations likely within 48 hours.";
                    } else {
                        snowMsg += " (Amounts hidden until 48hr window).";
                    }
                    snowDiv.innerHTML = snowMsg;
                    snowDiv.style.display = 'block';
                }

                // 4. Buncombe Alerts
                const aReq = await fetch(ALERTS_URL);
                const aData = await aReq.json();
                const localAlerts = aData.features.filter(a => a.properties.areaDesc.includes("Buncombe"));
                if (localAlerts.length > 0) {
                    const alertDiv = document.getElementById('nws-alert');
                    alertDiv.innerText = `‚ö†Ô∏è NWS ALERT: ${localAlerts[0].properties.event}`;
                    alertDiv.style.display = 'block';
                }

            } catch (e) {
                console.error(e);
                document.getElementById('comfort-report').innerText = "Neutral (Station Offline)";
                document.getElementById('bin-status').innerText = "Calm (Station Offline)";
            }
        }

        updateWeather();
    </script>
</body>
</html>
