<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>828 Weather Direct</title>
    <style>
        :root { --navy: #15286c; --orange: #e27030; --light-bg: #f4f7f9; --red: #d63031; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--light-bg); color: #333; padding: 20px; max-width: 600px; margin: auto; }
        header { background: var(--navy); color: white; padding: 25px; border-radius: 15px 15px 0 0; text-align: center; }
        h1 { margin: 0; font-size: 1.8em; letter-spacing: 1px; }
        .card { background: white; border-radius: 0 0 15px 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: 4px solid var(--orange); }
        .alert-pill { color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; text-align: center; line-height: 1.4; }
        .impact-bar { display: flex; justify-content: center; gap: 25px; margin-bottom: 20px; }
        .impact-icon { font-size: 2.2em; opacity: 0.15; filter: grayscale(1); transition: 0.3s; position: relative; }
        .impact-icon.active { opacity: 1; filter: grayscale(0); }
        .impact-label { font-size: 0.4em; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); color: var(--navy); font-weight: bold; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        .label { font-size: 0.7em; color: var(--navy); font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .value { font-size: 1.1em; font-weight: 600; }
        .btn-geo { background: var(--orange); color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 20px; font-size: 1em; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <header><h1>828 Weather Direct</h1></header>
    <div class="card">
        <div class="impact-bar">
            <div id="icon-snow" class="impact-icon">‚ùÑÔ∏è<span class="impact-label">SNOW</span></div>
            <div id="icon-rain" class="impact-icon">üåßÔ∏è<span class="impact-label">RAIN</span></div>
        </div>
        <div id="main-alert" class="alert-pill"></div>
        <button class="btn-geo" onclick="getLocation()">Detect My Elevation & Station</button>
        <div class="stat-grid">
            <div class="stat-item"><span class="label">PWS Temp</span><div id="local-temp" class="value">--¬∞F</div></div>
            <div class="stat-item"><span class="label">Elevation</span><div id="user-elev" class="value">-- ft</div></div>
            <div class="stat-item"><span class="label">Human Comfort</span><div id="comfort-report" class="value">Loading...</div></div>
            <div class="stat-item"><span class="label">Wind Status</span><div id="wind-status" class="value">Loading...</div></div>
        </div>
    </div>

    <script>
        const NWS_PROXY = "https://api.allorigins.win/get?url=";

        // Default to Asheville City
        window.onload = () => updateWeather(35.5951, -82.5515);

        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('user-elev').innerText = "Locating...";
                navigator.geolocation.getCurrentPosition(pos => {
                    updateWeather(pos.coords.latitude, pos.coords.longitude);
                }, () => updateWeather(35.5951, -82.5515));
            }
        }

        async function updateWeather(lat, lon) {
            try {
                // 1. OPEN-METEO DATA (Direct, No Proxy)
                // Includes: Current Temp, Elevation, Dewpoint, Wind Gusts, Snowfall
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_gusts_10m&hourly=dew_point_2m,snowfall,rain&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&elevation=true&forecast_days=3`;
                
                const response = await fetch(weatherUrl);
                const data = await response.json();

                // Elevation & Temp
                document.getElementById('user-elev').innerText = Math.round(data.elevation * 3.28084) + " ft";
                document.getElementById('local-temp').innerText = Math.round(data.current.temperature_2m) + "¬∞F";

                // Human Comfort (Dew Point)
                const dewPoint = data.hourly.dew_point_2m[0];
                const temp = data.current.temperature_2m;
                const comfort = document.getElementById('comfort-report');
                if (temp >= 65) {
                    if (dewPoint < 55) comfort.innerText = "üß§ Crisp";
                    else if (dewPoint <= 60) comfort.innerText = "üëå Pleasant";
                    else comfort.innerText = "üíß Sticky";
                } else {
                    comfort.innerText = "Neutral (Cool)";
                }

                // Wind Status (Actionable Tiers)
                const gusts = data.current.wind_gusts_10m;
                const windStatus = document.getElementById('wind-status');
                const alertPill = document.getElementById('main-alert');
                
                if (gusts >= 40) {
                    windStatus.innerText = "HIGH IMPACT";
                    alertPill.style.display = 'block'; alertPill.style.background = 'var(--red)';
                    alertPill.innerHTML = `üö® Stay indoors if possible; falling limbs and power outages likely.`;
                } else if (gusts >= 25) {
                    windStatus.innerText = "BIN ALERT";
                    alertPill.style.display = 'block'; alertPill.style.background = 'var(--orange)';
                    alertPill.innerHTML = `‚ö†Ô∏è Secure bins and porch/patio furniture. Some power outages possible.`;
                } else if (gusts >= 20) {
                    windStatus.innerText = "GUSTY";
                    alertPill.style.display = 'block'; alertPill.style.background = 'var(--navy)';
                    alertPill.innerHTML = `‚ÑπÔ∏è Keep an eye on your green garbage bins!`;
                } else {
                    windStatus.innerText = "CALM (" + Math.round(gusts) + " mph)";
                    alertPill.style.display = 'none';
                }

                // Snow & Rain Icons (Look ahead 48h)
                const hasSnow = data.hourly.snowfall.slice(0, 48).some(s => s > 0);
                const hasHeavyRain = data.hourly.rain.slice(0, 12).some(r => r > 0.1); // 0.1in per hour
                if (hasSnow) document.getElementById('icon-snow').classList.add('active');
                if (hasHeavyRain) document.getElementById('icon-rain').classList.add('active');

                // 2. NWS ALERTS (Through Proxy - Only for official text)
                fetchNWSAlerts(lat, lon);

            } catch (e) {
                console.error("Open-Meteo Error", e);
                document.getElementById('comfort-report').innerText = "Offline";
            }
        }

        async function fetchNWSAlerts(lat, lon) {
            try {
                const alertUrl = `https://api.weather.gov/alerts/active?point=${lat},${lon}`;
                const res = await fetch(NWS_PROXY + encodeURIComponent(alertUrl));
                const wrapper = await res.json();
                const aData = JSON.parse(wrapper.contents);
                
                if (aData.features && aData.features.length > 0) {
                    const alertPill = document.getElementById('main-alert');
                    const event = aData.features[0].properties.event;
                    // Only overwrite if wind isn't already showing a higher-priority alert
                    if (alertPill.style.display !== 'block') {
                        alertPill.style.display = 'block';
                        alertPill.style.background = 'var(--navy)';
                        alertPill.innerHTML = `‚ö†Ô∏è NWS ALERT: ${event}`;
                    }
                }
            } catch (e) { console.log("NWS Alert Fetch skipped or failed."); }
        }
    </script>
</body>
</html>
