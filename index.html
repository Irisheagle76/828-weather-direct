<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>828 Weather Direct – WU Powered</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root {
  --card-padding: 1.5rem;
  --module-padding: 1rem 1.2rem;
  --module-radius: 22px;
  --gap: 1.4rem;
}

@media (max-height: 700px), (max-width: 380px) {
  :root {
    --card-padding: 1rem;
    --module-padding: 0.8rem 1rem;
    --module-radius: 18px;
    --gap: 1rem;
  }
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #0a0f1c;
  color: #f5f5f5;
  margin: 0;
  padding: var(--card-padding);
}

.card {
  max-width: 720px;
  margin: 0 auto;
  background: #141a2a;
  border-radius: var(--module-radius);
  padding: var(--card-padding);
  box-shadow: 0 18px 40px rgba(0,0,0,0.45);
  border: 1px solid rgba(255,255,255,0.05);
}

h1 { margin: 0 0 0.4rem; font-size: 1.6rem; letter-spacing: 0.03em; }
.subtitle { font-size: 0.9rem; color: #9aa3c2; margin-bottom: var(--gap); }

.status-row { display: flex; gap: 0.75rem; margin-bottom: var(--gap); }
.badge {
  display: inline-flex; align-items: center; gap: 0.4rem;
  padding: 0.3rem 0.7rem; border-radius: 999px;
  font-size: 0.78rem; text-transform: uppercase;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.04);
}
.badge-dot { width: 8px; height: 8px; border-radius: 999px; background: #f5c84c; }
.badge-dot.ok { background: #ffa94d; }
.badge-dot.error { background: #fb7185; }

.now-tomorrow-row { display: flex; flex-wrap: wrap; gap: var(--gap); margin-bottom: var(--gap); }
.now-col, .tomorrow-col { flex: 1 1 260px; }

.comfort-module, .action-module {
  border-radius: var(--module-radius);
  padding: var(--module-padding);
  display: flex; gap: 0.8rem;
}

.comfort-module {
  background: rgba(255,169,77,0.10);
  border: 1px solid rgba(255,169,77,0.35);
}

.action-module {
  background: rgba(120,180,255,0.10);
  border: 1px solid rgba(120,180,255,0.35);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: var(--gap);
}

.metric {
  background: rgba(255,255,255,0.03);
  border-radius: var(--module-radius);
  padding: 0.75rem 0.9rem;
}

.trend-module {
  margin-top: var(--gap);
  background: rgba(255,169,77,0.10);
  border: 1px solid rgba(255,169,77,0.25);
  border-radius: var(--module-radius);
  padding: var(--module-padding);
}

.trend-headline { font-weight: 700; color: #ffa94d; margin-bottom: 0.35rem; }
.trend-text { font-size: 0.9rem; color: #d8d8e0; }

.footer-note {
  margin-top: var(--gap);
  font-size: 0.78rem;
  color: #e0b27a;
  text-align: center;
}
</style>
</head>

<body>
<div class="card">
<h1>828 Weather Direct</h1>
<div class="subtitle">Hyper-local conditions via Weather Underground PWS network</div>

<div class="trend-module">
  <div id="trend-headline" class="trend-headline">Analyzing recent weather…</div>
  <div id="trend-text" class="trend-text">Looking back over the last 60 days…</div>
</div>

<div class="footer-note" id="wu-station-footer">
Live data from Weather Underground
</div>
</div>

<script>

/* ---------------- HISTORICAL FETCH ---------------- */

async function getHistoricalDaily(lat, lon) {
  const end = new Date();
  end.setDate(end.getDate() - 2);

  const start = new Date(end);
  start.setDate(start.getDate() - 60);

  const format = d => d.toISOString().split("T")[0];

  const url =
    `https://archive-api.open-meteo.com/v1/archive` +
    `?latitude=${lat}&longitude=${lon}` +
    `&start_date=${format(start)}` +
    `&end_date=${format(end)}` +
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum` +
    `&timezone=America/New_York`;

  const res = await fetch(url);
  const data = await res.json();

  const out = [];

  for (let i = 0; i < data.daily.time.length; i++) {
    out.push({
      date: data.daily.time[i],
      tMean: (data.daily.temperature_2m_max[i] +
              data.daily.temperature_2m_min[i]) / 2,
      precip: data.daily.precipitation_sum[i] ?? 0
    });
  }

  return out;
}

/* ---------------- TREND ENGINE ---------------- */

function analyzeHistoricalTrends(daily) {
  const monthlyNormals = [38,42,50,58,66,73,77,76,69,59,49,40];

  let departures = [];
  let totalPrecip = 0;
  let dryDays = 0;
  let wetDays = 0;

  for (const d of daily) {
    const month = new Date(d.date).getMonth();
    const normal = monthlyNormals[month];
    const dep = d.tMean - normal;

    departures.push(dep);
    totalPrecip += d.precip;

    if (d.precip < 0.01) dryDays++;
    if (d.precip >= 0.10) wetDays++;
  }

  const meanDeparture =
    departures.reduce((a,b)=>a+b,0)/departures.length;

  const avgPrecipPerDay = totalPrecip / daily.length;
  const normalDailyPrecip = 0.13;
  const precipDeparture = avgPrecipPerDay - normalDailyPrecip;

  let headline;
  let parts = [];

  if (meanDeparture >= 4) {
    headline = "Sustained Warm Pattern";
    parts.push(`Averaging ${meanDeparture.toFixed(1)}° above normal`);
  } else if (meanDeparture <= -4) {
    headline = "Sustained Cold Pattern";
    parts.push(`Averaging ${Math.abs(meanDeparture).toFixed(1)}° below normal`);
  } else {
    headline = "Near Seasonal Pattern";
    parts.push("Temperatures close to seasonal norms");
  }

  if (precipDeparture >= 0.05)
    parts.push("with a rainfall surplus");
  else if (precipDeparture <= -0.05)
    parts.push("with a rainfall deficit");
  else
    parts.push("with near-normal precipitation");

  if (dryDays >= 35) parts.push("including a prolonged dry stretch");
  if (wetDays >= 20) parts.push("with frequent wet days");

  return {
    headline,
    text: parts.join(", ") + "."
  };
}

/* ---------------- INIT ---------------- */

async function init() {
  const lat = 35.5951;
  const lon = -82.5515;

  try {
    const history = await getHistoricalDaily(lat, lon);
    const trend = analyzeHistoricalTrends(history);

    document.getElementById("trend-headline").textContent = trend.headline;
    document.getElementById("trend-text").textContent = trend.text;
  } catch (e) {
    document.getElementById("trend-headline").textContent = "Trend Error";
    document.getElementById("trend-text").textContent = "Unable to load historical data.";
  }
}

document.addEventListener("DOMContentLoaded", init);

</script>
</body>
</html>
