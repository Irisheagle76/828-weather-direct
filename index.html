<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>828 Weather Direct</title>
    <style>
        :root { --navy: #15286c; --orange: #e27030; --light-bg: #f4f7f9; --red: #d63031; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--light-bg); color: #333; padding: 20px; max-width: 600px; margin: auto; }
        header { background: var(--navy); color: white; padding: 25px; border-radius: 15px 15px 0 0; text-align: center; }
        h1 { margin: 0; font-size: 1.8em; letter-spacing: 1px; }
        .card { background: white; border-radius: 0 0 15px 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: 4px solid var(--orange); }
        .alert-pill { color: white; padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; display: none; text-align: center; line-height: 1.4; }
        .impact-bar { display: flex; justify-content: center; gap: 25px; margin-bottom: 20px; }
        .impact-icon { font-size: 2.2em; opacity: 0.15; filter: grayscale(1); transition: 0.3s; position: relative; }
        .impact-icon.active { opacity: 1; filter: grayscale(0); }
        .impact-label { font-size: 0.4em; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); color: var(--navy); font-weight: bold; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        .label { font-size: 0.7em; color: var(--navy); font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .value { font-size: 1.1em; font-weight: 600; }
        .btn-geo { background: var(--orange); color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 20px; font-size: 1em; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .trend-card { background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-top: 20px; }
        .trend-text { font-size: 0.95em; line-height: 1.4; }
    </style>
</head>

<body>
    <header><h1>828 Weather Direct</h1></header>

    <div class="card">

        <div class="impact-bar">
            <div id="icon-snow" class="impact-icon">‚ùÑÔ∏è<span class="impact-label">SNOW</span></div>
            <div id="icon-rain" class="impact-icon">üåßÔ∏è<span class="impact-label">RAIN</span></div>
        </div>

        <div id="main-alert" class="alert-pill"></div>

        <button class="btn-geo" onclick="getLocation()">Detect My Elevation & Station</button>

        <div class="stat-grid">
            <div class="stat-item">
                <span class="label">PWS Temp</span>
                <div id="local-temp" class="value">--¬∞F</div>
            </div>
            <div class="stat-item">
                <span class="label">Your Elevation</span>
                <div id="user-elev" class="value">-- ft</div>
            </div>
            <div class="stat-item">
                <span class="label">Human Comfort</span>
                <div id="comfort-report" class="value">Syncing...</div>
            </div>
            <div class="stat-item">
                <span class="label">Wind Status</span>
                <div id="wind-status" class="value">Checking...</div>
            </div>
        </div>

        <div class="trend-card">
            <span class="label">Recent Weather Pattern</span>
            <div id="trend-summary" class="trend-text">Analyzing the last 60 days...</div>
        </div>
    </div>

    <script>
        window.onload = () => updateWeather(35.5951, -82.5515);

        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('user-elev').innerText = "Locating...";
                navigator.geolocation.getCurrentPosition(
                    pos => updateWeather(pos.coords.latitude, pos.coords.longitude),
                    () => updateWeather(35.5951, -82.5515)
                );
            }
        }

        function formatDate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        async function updateWeather(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_gusts_10m&hourly=dew_point_2m,snowfall,rain&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();

                // --- Core Data ---
                document.getElementById('local-temp').innerText =
                    Math.round(data.current.temperature_2m) + "¬∞F";

                const elevFeet = Math.round(data.elevation * 3.28084);
                document.getElementById('user-elev').innerText =
                    isNaN(elevFeet) ? "-- ft" : elevFeet + " ft";

                // --- Wind Logic ---
                const gusts = data.current.wind_gusts_10m ?? 0;
                const windStatus = document.getElementById('wind-status');
                const alertPill = document.getElementById('main-alert');

                alertPill.style.display = 'none';
                alertPill.innerHTML = "";

                if (gusts >= 40) {
                    windStatus.innerText = "HIGH IMPACT";
                    alertPill.style.display = 'block';
                    alertPill.style.background = 'var(--red)';
                    alertPill.innerHTML = "üö® Stay indoors if possible; falling limbs and power outages likely.";
                }
                else if (gusts >= 25) {
                    windStatus.innerText = "BIN ALERT";
                    alertPill.style.display = 'block';
                    alertPill.style.background = 'var(--orange)';
                    alertPill.innerHTML = "‚ö†Ô∏è Secure bins and porch/patio furniture. Some power outages possible.";
                }
                else if (gusts >= 20) {
                    windStatus.innerText = "QUITE BREEZY (gusting to " + Math.round(gusts) + " mph)";
                    alertPill.style.display = 'block';
                    alertPill.style.background = 'var(--navy)';
                    alertPill.innerHTML = "‚ÑπÔ∏è Keep an eye on your green garbage bins!";
                }
                else {
                    if (gusts <= 5) {
                        windStatus.innerText = "CALM (gusting occasionally to " + Math.round(gusts) + " mph)";
                    } else {
                        windStatus.innerText = "Light Winds (gusting occasionally to " + Math.round(gusts) + " mph)";
                    }
                }

                // --- Dew Point Matching ---
                const currentIndex = data.hourly.time.indexOf(data.current.time);
                const dewPoint = currentIndex >= 0
                    ? data.hourly.dew_point_2m[currentIndex]
                    : data.hourly.dew_point_2m[0];

                // --- Comfort Logic ---
                const temp = data.current.temperature_2m;
                const comfort = document.getElementById('comfort-report');

                if (temp <= 10 || (temp <= 20 && gusts >= 15)) {
                    comfort.innerText = "üö® DANGEROUSLY COLD: Frostbite risk!";
                }
                else if (temp >= 68 && temp <= 74 && dewPoint >= 45 && dewPoint <= 52) {
                    comfort.innerText = "‚ú® Goldilocks! Just right!";
                }
                else if (temp >= 75) {
                    if (dewPoint < 50) comfort.innerText = "‚ú® Ultra Crisp";
                    else if (dewPoint < 55) comfort.innerText = "üß§ Refreshing";
                    else if (dewPoint < 60) comfort.innerText = "üëå Pleasant";
                    else if (dewPoint < 65) comfort.innerText = "‚òÅÔ∏è Noticeable";
                    else if (dewPoint < 70) comfort.innerText = "üíß Muggy";
                    else if (dewPoint < 75) comfort.innerText = "üå°Ô∏è Oppressive";
                    else comfort.innerText = "üåã Extreme Humidity";
                }
                else if (temp < 45 && gusts > 15) {
                    comfort.innerText = "ü•∂ Biting Chill: Bundle up!";
                }
                else {
                    comfort.innerText = "Seasonably Comfortable Overall";
                }

                // --- Impacts ---
                const hasSnow = data.hourly.snowfall.slice(0, 48).some(s => s > 0);
                const hasRain = data.hourly.rain.slice(0, 24).some(r => r > 0.1);

                document.getElementById('icon-snow').classList.toggle('active', hasSnow);
                document.getElementById('icon-rain').classList.toggle('active', hasRain);

                // --- Trends (last 60 days) ---
                updateTrends(lat, lon);

            } catch (err) {
                document.getElementById('comfort-report').innerText = "Offline";
                document.getElementById('wind-status').innerText = "Offline";
                document.getElementById('trend-summary').innerText = "Trend data unavailable.";
            }
        }

        async function updateTrends(lat, lon) {
            const trendEl = document.getElementById('trend-summary');
            try {
                const today = new Date();
                const start = new Date();
                start.setDate(today.getDate() - 59); // last 60 days including today

                const startDate = formatDate(start);
                const endDate = formatDate(today);

                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_max,precipitation_sum&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto`;

                const response = await fetch(url);
                if (!response.ok) throw new Error("Archive API Error");
                const data = await response.json();

                const times = data.daily.time;
                const tmax = data.daily.temperature_2m_max;
                const precip = data.daily.precipitation_sum;
                const n = times.length;

                if (!times || !tmax || !precip || n === 0) {
                    trendEl.innerText = "Not enough recent data to analyze trends.";
                    return;
                }

                // --- Warm streak (>= 60¬∞F) ---
                let warmStreak = 0;
                for (let i = n - 1; i >= 0; i--) {
                    if (tmax[i] >= 60) warmStreak++;
                    else break;
                }

                // --- Dry streak (precip < 0.01") ---
                let dryStreak = 0;
                for (let i = n - 1; i >= 0; i--) {
                    if (precip[i] < 0.01) dryStreak++;
                    else break;
                }

                // --- Weekend pattern (last several Sundays) ---
                const weekendInfos = [];
                for (let i = n - 1; i >= 0; i--) {
                    const d = new Date(times[i]);
                    const dow = d.getUTCDay(); // 0 = Sunday
                    if (dow === 0) {
                        let wet = precip[i] > 0.05;
                        if (i - 1 >= 0) {
                            const dPrev = new Date(times[i - 1]);
                            if (dPrev.getUTCDay() === 6) {
                                if (precip[i - 1] > 0.05) wet = true;
                            }
                        }
                        weekendInfos.push({ date: d, wet });
                    }
                }

                let unsettledStreak = 0;
                let dryWeekendStreak = 0;
                if (weekendInfos.length > 0) {
                    // consecutive unsettled weekends from most recent
                    for (let i = 0; i < weekendInfos.length; i++) {
                        if (weekendInfos[i].wet) unsettledStreak++;
                        else break;
                    }
                    // consecutive mainly dry weekends from most recent
                    for (let i = 0; i < weekendInfos.length; i++) {
                        if (!weekendInfos[i].wet) dryWeekendStreak++;
                        else break;
                    }
                }

                const parts = [];

                if (warmStreak >= 3) {
                    parts.push(`Warm streak: ${warmStreak} consecutive day(s) at or above 60¬∞F.`);
                }

                if (dryStreak >= 3) {
                    parts.push(`Dry stretch: ${dryStreak} consecutive day(s) with little or no measurable precipitation.`);
                }

                if (unsettledStreak >= 2) {
                    parts.push(`Weekends: ${unsettledStreak} unsettled weekend(s) in a row (rain on Saturday and/or Sunday).`);
                } else if (dryWeekendStreak >= 2) {
                    parts.push(`Weekends: ${dryWeekendStreak} mainly dry weekend(s) in a row.`);
                }

                if (parts.length === 0) {
                    trendEl.innerText = "No strong recent pattern ‚Äî conditions have been fairly changeable over the last 60 days.";
                } else {
                    trendEl.innerText = parts.join(" ");
                }

            } catch (err) {
                trendEl.innerText = "Trend data unavailable.";
            }
        }
    </script>

</body>
</html>
